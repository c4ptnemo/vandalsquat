<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VandalSquat – My Account</title>
  </head>

  <body>
    <div class="auth-container">
      <div class="auth-box auth-box--wide">
        <h2>My Account</h2>

        <% if flash[:success] %>
          <p class="auth-success"><%= flash[:success] %></p>
        <% end %>

        <% if flash[:alert] %>
          <p class="auth-error"><%= flash[:alert] %></p>
        <% end %>

        <!-- Two-Factor Authentication -->
        <section class="account-section">
          <h3>Security</h3>
          <p style="color: #bdbdbd; margin-bottom: 12px;">
            <% if current_user.otp_enabled? %>
              ✅ Two-factor authentication is <strong style="color: #4caf50;">enabled</strong>
            <% else %>
              ⚠️ Two-factor authentication is <strong style="color: #ff9800;">disabled</strong>
            <% end %>
          </p>
          <p>
            <%= link_to "Manage Two-Factor Authentication →", two_factor_path, style: "color: #4caf50; text-decoration: underline;" %>
          </p>
        </section>

        <hr style="border: none; border-top: 1px solid #222; margin: 32px 0;" />

        <!-- Change email -->
        <section class="account-section">
          <h3>Change Email</h3>

          <%= form_with url: "/account/email", scope: :user, method: :patch, local: true do |f| %>
            <p>
              <label>
                New email
                <%= f.email_field :email, required: true, value: current_user.email, placeholder: "Optional - for account recovery" %>
              </label>
              <span style="font-size: 0.8rem; color: #ff9800; display: block; margin-top: 4px;">
                ⚠️ Adding an email reduces anonymity
              </span>
            </p>

            <p>
              <label>
                Current password
                <input type="password" name="current_password" required>
              </label>
            </p>

            <p><%= f.submit "Update email" %></p>
          <% end %>
        </section>

        <hr style="border: none; border-top: 1px solid #222; margin: 32px 0;" />

        <!-- Change password -->
        <section class="account-section">
          <h3>Change Password</h3>

          <%= form_with url: "/account/password", scope: :user, method: :patch, local: true do |f| %>
            <p>
              <label>
                New password
                <%= f.password_field :password, required: true %>
              </label>
            </p>

            <p>
              <label>
                Confirm new password
                <%= f.password_field :password_confirmation, required: true %>
              </label>
            </p>

            <p>
              <label>
                Current password
                <input type="password" name="current_password" required>
              </label>
            </p>

            <p><%= f.submit "Update password" %></p>
          <% end %>
          
        </section>

        <hr style="border: none; border-top: 1px solid #222; margin: 32px 0;" />


        <!-- Danger Zone - Delete Account -->
        <section class="account-section">
          <h3 style="color: #ff6b6b; margin-bottom: 8px;">Danger Zone</h3>
          <p style="color: #999; font-size: 0.9rem; margin-bottom: 16px;">
            Once you delete your account, there is no going back. All your entries and photos will be permanently deleted.
          </p>

          <%= form_with url: delete_account_path, method: :delete, local: true, id: "delete-account-form" do |f| %>
            <p>
              <label>
                Enter your password to confirm deletion
                <input type="password" name="password" required placeholder="Current password">
              </label>
            </p>

            <p>
              <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; color: #ff6b6b;">
                <input type="checkbox" name="confirm_deletion" id="confirm-deletion-checkbox" required style="margin-top: 4px; width: 18px; height: 18px;">
                <span style="flex: 1;">
                  I understand this action cannot be undone. My account and all entries will be permanently deleted and cannot be recovered.
                </span>
              </label>
            </p>

            <p>
              <%= f.submit "Delete My Account Permanently", class: "btn-danger", id: "delete-account-btn" %>
            </p>
          <% end %>
        </section>

        <script>
          // Disable submit button until checkbox is checked
          document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('delete-account-form');
            const checkbox = document.getElementById('confirm-deletion-checkbox');
            const submitBtn = document.getElementById('delete-account-btn');
            
            // Initially disable button
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            
            // Enable/disable based on checkbox
            checkbox.addEventListener('change', function() {
              if (this.checked) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
              } else {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
              }
            });
          });
        </script>
      </div>
    </div>
  </body>
</html>