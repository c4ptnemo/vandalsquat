<h2>New Entry â€” Choose Location</h2>

<p>Step 1 of 2: Click the map to drop a pin, then continue.</p>

<div
  id="map"
  data-mapbox-token="<%= ENV["MAPBOX_PUBLIC_TOKEN"] %>"
  style="width: 100%; height: 500px;"
></div>

<p style="margin-top: 1rem;">
  <button id="continue-btn" disabled>
    Continue to details
  </button>
</p>

<script>
  (function () {
    const mapEl = document.getElementById("map");
    const token = mapEl.dataset.mapboxToken;
    const continueBtn = document.getElementById("continue-btn");

    let selectedLat = null;
    let selectedLng = null;
    let marker = null;

    mapboxgl.accessToken = token;

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v12",
      center: [-87.6298, 41.8781], // default: Chicago
      zoom: 11
    });

    map.on("click", (e) => {
      selectedLng = e.lngLat.lng;
      selectedLat = e.lngLat.lat;

      if (marker) marker.remove();
      marker = new mapboxgl.Marker()
        .setLngLat([selectedLng, selectedLat])
        .addTo(map);

      continueBtn.disabled = false;
    });

    continueBtn.addEventListener("click", () => {
      if (selectedLat && selectedLng) {
        window.location.href =
          `/entries/new/details?lat=${encodeURIComponent(selectedLat)}&lng=${encodeURIComponent(selectedLng)}`;
      }
    });
  })();
</script>
